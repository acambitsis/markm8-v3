name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [dev]

jobs:
  check-migrations:
    name: Check migration documentation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check if migrations were modified
        id: migrations
        run: |
          # Get list of changed files in this PR
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Check if any migration files were added or modified
          if echo "$CHANGED_FILES" | grep -q "^convex/seed/migrations/"; then
            echo "modified=true" >> $GITHUB_OUTPUT
            echo "Migration files were modified:"
            echo "$CHANGED_FILES" | grep "^convex/seed/migrations/"
          else
            echo "modified=false" >> $GITHUB_OUTPUT
            echo "No migration files modified"
          fi

      - name: Verify PR description includes post-deployment section
        if: steps.migrations.outputs.modified == 'true'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          if echo "$PR_BODY" | grep -qi "post-deployment"; then
            echo "‚úÖ PR description includes post-deployment section"
          else
            echo "::error::‚ùå Migration files were modified but PR description is missing 'Post-deployment' section."
            echo ""
            echo "Please add a Post-deployment section to your PR description with the migration command:"
            echo ""
            echo "  ## Post-deployment"
            echo "  Run migration after deploying to production:"
            echo "  \`\`\`bash"
            echo "  npx convex run seed/migrations/<script>:migrate --prod"
            echo "  \`\`\`"
            echo ""
            exit 1
          fi

  build:
    strategy:
      matrix:
        node-version: [20.x, 22.6] # Need to use 22.6 due to Next.js build errors: https://github.com/vercel/next.js/issues/69263
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    name: Build with ${{ matrix.node-version }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - run: bun install
      - run: bun run build

  test:
    strategy:
      matrix:
        node-version: [20.x]

    name: Run all tests
    runs-on: ubuntu-latest

    env:
      CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
      NEXT_PUBLIC_CLERK_SIGN_IN_URL: ${{ secrets.NEXT_PUBLIC_CLERK_SIGN_IN_URL }}

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Retrieve Git history, needed to verify commits
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - run: bun install

      - name: Build Next.js for E2E tests
        run: bun run build

      - if: github.event_name == 'pull_request'
        name: Validate all commits from PR
        run: bunx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

      - name: Linter
        run: bun run lint

      - name: Type checking
        run: bun run check-types

      - name: Run unit tests
        run: bun run test -- --coverage

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4

      - name: Install Playwright (used for Storybook and E2E tests)
        run: bunx playwright install --with-deps

      - name: Run storybook tests
        run: bun run test-storybook:ci

      # E2E tests disabled - flaky Clerk auth in CI environment
      # TODO: Re-enable once E2E auth is stabilized
      # - name: Run E2E tests
      #   if: github.ref == 'refs/heads/main'
      #   run: bun run test:e2e

      # - uses: actions/upload-artifact@v4
      #   if: failure() && github.ref == 'refs/heads/main'
      #   with:
      #     name: e2e-test-results
      #     path: test-results/
      #     retention-days: 7

  notify-deployment:
    name: Notify Slack
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')

    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_DEV: ${{ secrets.SLACK_WEBHOOK_DEV_RELEASES }}
          SLACK_WEBHOOK_PROD: ${{ secrets.SLACK_WEBHOOK_PROD_RELEASES }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
        run: |
          # Determine environment and webhook URL
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            ENV_LABEL="üöÄ Production"
            WEBHOOK_URL="$SLACK_WEBHOOK_PROD"
          else
            ENV_LABEL="üß™ Dev"
            WEBHOOK_URL="$SLACK_WEBHOOK_DEV"
          fi

          # Extract first line of commit message for cleaner display
          COMMIT_TITLE=$(echo "$COMMIT_MESSAGE" | head -n 1)

          # Build the message
          MESSAGE="*${ENV_LABEL} deployed*\n${COMMIT_TITLE}\n\n_by ${COMMIT_AUTHOR}_ ‚Ä¢ <${COMMIT_URL}|View commit>"

          # Send to Slack
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\": \"${MESSAGE}\"}" \
            "$WEBHOOK_URL"
