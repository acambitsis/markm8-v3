# MarkM8 v3 - Setup Guide

This guide covers the one-time setup required for the Convex + Vercel architecture.

---

## Prerequisites

- **Package Manager:** [Bun](https://bun.sh) (recommended for faster installs) or [npm](https://www.npmjs.com/)/[pnpm](https://pnpm.io/)
- [Convex account](https://convex.dev) (free tier available)
- [Clerk account](https://clerk.com) with existing project
- [Vercel account](https://vercel.com) for deployment
- [Stripe account](https://stripe.com) for payments (Phase 3)
- [OpenRouter account](https://openrouter.ai) for AI grading (Phase 5)

**Note:** All commands in this guide use `bun`, but you can substitute with `npm` or `pnpm` as needed.

---

## 1. Initialize Convex Project

Run the Convex setup wizard:

```bash
npx convex dev --once --configure=new
```

This will:
- Create a new Convex project (or link to existing)
- Generate `.env.local` with `CONVEX_DEPLOYMENT` and `NEXT_PUBLIC_CONVEX_URL`
- Create `convex/_generated/` directory with TypeScript types

**Keep the terminal running** or note the project URL for the next steps.

---

## 2. Configure Clerk for Convex

### 2.1 Create JWT Template

In [Clerk Dashboard](https://dashboard.clerk.com) → **JWT Templates**:

1. Click **New template**
2. Select **Convex** preset (or create blank)
3. **CRITICAL:** Name it exactly `convex` (case-sensitive)
4. Note the **Issuer** URL (e.g., `https://verb-noun-00.clerk.accounts.dev`)
5. Save the template

### 2.2 Update Convex Auth Config

Edit `convex/auth.config.ts`:

```typescript
export default {
  providers: [
    {
      domain: 'https://your-clerk-instance.clerk.accounts.dev', // From step 2.1
      applicationID: 'convex',
    },
  ],
};
```

### 2.3 Configure Clerk Webhook

In [Clerk Dashboard](https://dashboard.clerk.com) → **Webhooks**:

1. Click **Add Endpoint**
2. **Endpoint URL:** `https://<your-project>.convex.site/clerk-webhook`
   - Find your Convex site URL in the Convex dashboard
3. **Subscribe to events:**
   - `user.created`
   - `user.updated`
   - `user.deleted`
4. Copy the **Signing Secret** (starts with `whsec_`)

### 2.4 Set Webhook Secret

In Convex Dashboard → **Settings** → **Environment Variables**:

```
CLERK_WEBHOOK_SECRET=whsec_your_signing_secret
```

---

## 3. Environment Variables

### Local Development (`.env.local`)

```bash
# Convex (auto-generated by npx convex dev)
CONVEX_DEPLOYMENT=dev:your-project
NEXT_PUBLIC_CONVEX_URL=https://your-project.convex.cloud

# Clerk (from your existing setup)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_xxx
CLERK_SECRET_KEY=sk_test_xxx

# OpenRouter (for AI grading - Phase 5)
OPENROUTER_API_KEY=sk-or-xxx  # Optional for local dev (required for live grading)

# Optional: Sentry, Logtail, etc. (keep existing values)
```

### Convex Dashboard Environment Variables

In Convex Dashboard → **Settings** → **Environment Variables**:

```
CLERK_WEBHOOK_SECRET=whsec_xxx
```

### Vercel Environment Variables (for production)

```
NEXT_PUBLIC_CONVEX_URL=https://your-project.convex.cloud
CONVEX_DEPLOY_KEY=prod:xxx  # From Convex Dashboard → Settings → Deploy Key
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_xxx
CLERK_SECRET_KEY=sk_live_xxx
```

---

## 4. Deploy Convex Schema

Deploy your schema and functions to Convex:

```bash
npx convex deploy
```

This pushes:
- Schema (`convex/schema.ts`)
- All functions (`convex/*.ts`)
- HTTP endpoints

---

## 5. Initialize Platform Settings

The `platformSettings` table stores admin-configurable values (like signup bonus). You must create the singleton document manually:

### Via Convex Dashboard

1. Go to [Convex Dashboard](https://dashboard.convex.dev) → Your Project → **Data**
2. Select the `platformSettings` table
3. Click **Add document**
4. Enter the following document:

```json
{
  "key": "singleton",
  "signupBonusAmount": "1.00"
}
```

5. Click **Save**

### Configuration Options

| Field | Type | Description | Default |
|-------|------|-------------|---------|
| `key` | `"singleton"` | Required identifier (must be exactly `"singleton"`) | - |
| `signupBonusAmount` | string | Credits given to new users on signup (e.g., `"1.00"`, `"0.50"`, `"0.00"`) | `"1.00"` |

**Note:** If this document doesn't exist, the system falls back to `"1.00"` signup bonus. Creating it allows you to change the value without code changes.

---

## 6. Verify Setup

### Test Locally

```bash
bun --bun run dev
```

This runs:
- Next.js development server
- Convex development server (watches for changes)

### Verify Clerk Integration

1. Open the app and sign up/sign in
2. Check Convex Dashboard → **Data** → `users` table
3. User should be created automatically via webhook

### Verify Credits

1. New user should have `credits` record with `balance: "1.00"`
2. Check Convex Dashboard → **Data** → `credits` table

---

## 7. Deploy to Vercel

### 7.1 Connect Repository

1. Import your GitHub repo to Vercel
2. Set **Framework Preset:** Next.js
3. Set **Build Command:** (see below for preview vs production)
4. Set **Install Command:** `bun install` (or `npm install` / `pnpm install` if not using Bun)

### 7.2 Configure Build Commands

Convex should only deploy on production builds to prevent preview branches from affecting the live backend.

**In Vercel Project Settings → General → Build & Development Settings:**

| Environment | Build Command | Purpose |
|-------------|---------------|---------|
| **Production** | `bun run build:prod` | Deploys Convex functions + builds Next.js |
| **Preview** | `bun run build` | Builds Next.js only (uses existing Convex backend) |

To set different commands per environment:
1. Go to **Settings** → **General** → **Build & Development Settings**
2. Override the build command
3. Or use **Settings** → **Environment Variables** with `VERCEL_ENV` detection

**Alternative:** Use environment detection in a single command:
```bash
if [ "$VERCEL_ENV" = "production" ]; then bun run build:prod; else bun run build; fi
```

### 7.3 Add Environment Variables

In Vercel Project Settings → **Environment Variables**, add all variables from step 3.

**Critical:** Add `CONVEX_DEPLOY_KEY` from Convex Dashboard → Settings → Deploy Key.

### 7.4 Update Clerk Webhook (Production)

Update Clerk webhook URL to production Convex endpoint:
`https://<your-production-project>.convex.site/clerk-webhook`

---

## 8. OpenRouter Setup (AI Grading)

OpenRouter provides access to multiple AI models for essay grading.

### 8.1 Get API Key

1. Sign up at [OpenRouter.ai](https://openrouter.ai)
2. Go to **Keys** → **Create Key**
3. Copy your API key (starts with `sk-or-`)

### 8.2 Set Environment Variables

**Convex Dashboard** → **Settings** → **Environment Variables**:

```
OPENROUTER_API_KEY=sk-or-your-key-here
```

**Note:** This must be set in Convex (not just `.env.local`) because AI grading runs in Convex actions.

### 8.3 Configure Grading Mode (Optional)

By default, grading uses mock mode. To enable real AI grading:

**Convex Dashboard** → **Settings** → **Environment Variables**:

```
MARKM8_GRADING_MODE=live
MARKM8_GRADING_MODELS=x-ai/grok-4.1,x-ai/grok-4.1,google/gemini-3
```

**Model Configuration:**
- `MARKM8_GRADING_MODE`: `mock` (default) or `live`
- `MARKM8_GRADING_MODELS`: Comma-separated list of OpenRouter model IDs (3-5 models)
  - Example: `x-ai/grok-4.1,x-ai/grok-4.1,google/gemini-3`
  - Supports mixed models (different model per run)
- `MARKM8_GRADING_RUNS`: Number of parallel runs (3-5, default: 3)

**Recommended Models:**
- `x-ai/grok-4.1` - Fast, cost-effective
- `google/gemini-3` - Good balance
- `anthropic/claude-opus-4.5` - High quality (more expensive)
- `openai/gpt-5.2` - Latest GPT model

### 8.4 Verify AI Grading

1. Submit a test essay with `MARKM8_GRADING_MODE=live`
2. Check Convex logs for AI API calls
3. Verify grade results appear correctly

---

## 9. Stripe Setup (Phase 3)

*To be completed when implementing payments.*

### Environment Variables

```bash
# Local
STRIPE_SECRET_KEY=sk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx

# Convex Dashboard (for webhook handler)
STRIPE_SECRET_KEY=sk_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
```

### Webhook Configuration

Create Stripe webhook pointing to:
`https://<your-project>.convex.site/stripe-webhook`

Subscribe to:
- `checkout.session.completed`
- `payment_intent.succeeded`

---

## Troubleshooting

### "Unauthorized: User not found in database"

The Clerk webhook hasn't synced the user yet. Check:
1. Webhook URL is correct in Clerk Dashboard
2. `CLERK_WEBHOOK_SECRET` is set in Convex Dashboard
3. Check Convex logs for webhook errors

### "Cannot find module './_generated/api'"

Run `npx convex dev` to generate TypeScript types.

### Convex functions not updating

1. Ensure `npx convex dev` is running
2. Check for TypeScript errors in terminal
3. Run `npx convex deploy` to force push

### Type errors after schema changes

After modifying `convex/schema.ts`:
1. Convex auto-regenerates types (may take a few seconds)
2. Restart TypeScript server in your IDE
3. If persistent, run `npx convex dev --once`

---

## Architecture Overview

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│     Vercel      │     │     Convex      │     │     Clerk       │
│   (Next.js)     │────▶│   (Database +   │◀────│    (Auth)       │
│                 │     │    Functions)   │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │                       │                       │
        │   useQuery/useMutation│                       │
        │◀──────────────────────│                       │
        │   (real-time)         │                       │
        │                       │                       │
        │                       │   Webhook (user sync) │
        │                       │◀──────────────────────│
        │                       │                       │
        │                       │   ctx.auth.getUserIdentity()
        │                       │──────────────────────▶│
```

### Key Data Flows

1. **User signs up** → Clerk → Webhook → Convex creates user + credits
2. **User submits essay** → useMutation → Convex mutation → Schedules grading action
3. **Grading completes** → Convex mutation → Real-time subscription → UI updates automatically
4. **User views grade** → useQuery → Convex query → Real-time updates while processing
