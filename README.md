# MarkM8

Pay-per-essay AI grading for students.

## Quick Start

```bash
# Install dependencies
bun install

# Initialize Convex (first time only)
npx convex dev --once --configure=new

# Start dev server (Next.js + Convex)
bun --bun run dev
```

Bun is recommended but npm/pnpm work equally well.

## Documentation

| Doc | Purpose |
|-----|---------|
| [CLAUDE.md](CLAUDE.md) | Development context, tech stack, patterns |
| [docs/FUNCTIONAL_REQUIREMENTS.md](docs/FUNCTIONAL_REQUIREMENTS.md) | Features and user journeys |
| [docs/TECHNICAL_DESIGN.md](docs/TECHNICAL_DESIGN.md) | Architecture and schema |

---

## Setup

### Prerequisites

- [Bun](https://bun.sh) (recommended) or npm/pnpm
- [Convex account](https://convex.dev)
- [Clerk account](https://clerk.com)
- [Vercel account](https://vercel.com)
- [Stripe account](https://stripe.com)
- [OpenRouter account](https://openrouter.ai)

### Environment Variables

**Authoritative source:** `src/libs/Env.ts` (validated with t3-env)

#### Local Development (`.env.local`)

```bash
# Convex (auto-generated by npx convex dev)
CONVEX_DEPLOYMENT=dev:your-project
NEXT_PUBLIC_CONVEX_URL=https://your-project.convex.cloud

# Clerk
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_xxx
CLERK_SECRET_KEY=sk_test_xxx
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in

# Stripe
STRIPE_SECRET_KEY=sk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_xxx

# Optional
NEXT_PUBLIC_APP_URL=http://localhost:3000
OPENROUTER_API_KEY=sk-or-xxx
```

#### Convex Dashboard

Settings > Environment Variables:

```
CLERK_WEBHOOK_SECRET=whsec_xxx
STRIPE_SECRET_KEY=sk_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
OPENROUTER_API_KEY=sk-or-xxx
```

#### Vercel (Production)

Same as `.env.local` plus:
- `CONVEX_DEPLOY_KEY=prod:xxx`
- Use `pk_live_xxx` / `sk_live_xxx` keys

### Clerk Configuration

**JWT Template** (Clerk Dashboard > JWT Templates):
1. New template > Convex preset
2. Name exactly `convex` (case-sensitive)
3. Note Issuer URL for `convex/auth.config.ts`

**Webhook** (Clerk Dashboard > Webhooks):
- Endpoint: `https://<project>.convex.site/clerk-webhook`
- Events: `user.created`, `user.updated`, `user.deleted`
- Copy signing secret to Convex Dashboard

### Stripe Configuration

**Webhook** (Stripe Dashboard > Developers > Webhooks):
- Endpoint: `https://<project>.convex.site/stripe-webhook`
- Events: `checkout.session.completed`
- Copy signing secret to Convex Dashboard

### Platform Settings (Optional)

In Convex Dashboard > Data > `platformSettings`:

```json
{ "key": "singleton", "signupBonusAmount": "1.00" }
```

Defaults to `"1.00"` if not created.

---

## Deployment

### Vercel Build Commands

| Branch | Command | Effect |
|--------|---------|--------|
| `main` | `bun run build:prod` | Deploys Convex + builds Next.js |
| Others | `bun run build` | Builds Next.js only |

Handled automatically by `scripts/build-ci.mjs`.

### Production Webhooks

Update endpoints to production Convex URL:
- Clerk: `https://<prod-project>.convex.site/clerk-webhook`
- Stripe: `https://<prod-project>.convex.site/stripe-webhook`

---

## Troubleshooting

**"Unauthorized: User not found in database"**
- Webhook URL correct in Clerk Dashboard?
- `CLERK_WEBHOOK_SECRET` set in Convex Dashboard?
- Check Convex logs for errors

**"Cannot find module './_generated/api'"**
- Run `npx convex dev` to generate types

**Convex functions not updating**
- Ensure `npx convex dev` is running
- Check for TypeScript errors
- Run `npx convex deploy` to force push
